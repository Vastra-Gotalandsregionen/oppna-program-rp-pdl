=PDL anpassa din webbaserade vårdapplikation=
*Innehåll*
<wiki:toc max_depth="3"/>

==Bakgrund och ändamål==
Patientdatalagen syftar till att reglera hur vårdpersonal tar del av patientinformation. 

Applikationen "Sök patientinformation med stöd för PDL" innehåller ett gränssnitt som guidar användaren att göra de val som krävs för att PDL ska uppfyllas. När information valts ut så visas den i en visare som ej ska göra annan information tillgänglig än den som användaren aktivt har valt.

Ändamålet med applikationen är främst att skapa en central ingång för att visa patientinformation och samtidigt förenkla för webbsystem att stödja PDL.

*Externa resurser*

  * [http://www.socialstyrelsen.se/regelverk/handbocker/handbokominformationshanteringochjournalforing Socialstyrelsens handbok för PDL]. 

==Funktionsbeskrivning==
I korthet så kräver PDL att ett antal krav uppfylls innan patientinformation visas.

  # Vårdpersonal ska identifieras med stark autentisering (exempelvis SITHS e-legitimation)
  # Vårdpersonal ska ha en aktiv patientrelation med patienten
  # Vårdpersonal arbetar med ett aktuellt vårduppdrag som beskriver vad han eller hon får tillgång att se
  # Vårdpersonal kan direkt välja bland information som tillhör den vårdenhet som uppdraget ligger på
  # Vårdpersonal måste aktivt välja att få se information från andra vårdenheter eller vårdgivare (om uppdraget tillåter det
  # Vårdpersonal måste aktivt välja vilken information som är relevant för det aktuella tillfället
  # Alla val som gör loggas i en systemlogg och ligger till grund för uppföljning för att stävja missbruk
  # Vid sammanhållen journalföring (direktåtkomst av information från annan vårdgivare) så krävs att patienten har gett sitt samtycke till sammanhållen journalföring
  # Vårdpersonal som sökt på en patient med spärrad information på annan vårdenhet behöver göra ett aktivt val att få se på vilken vårdenhet den spärrade informationen finns
  # Vårdpersonal som vill få tillgång till spärrad information på annan vårdenhet behöver inhämta samtycke från patient eller intyga att en nödsituation råder
  # Vårdpersonal kan ej komma åt spärrad information hos andra vårdgivare utan att först kontakta denna vårdgivare och be dem att öppna spärren för dem 

==Användargränssnitt==
Flöde vår Vårdpersonal som vill söka på patientinformation. Detta flödet visar alla situationer som kan uppstå inom PDL. I normalfallet så räcker det med tre musklick.

*Inre sekretess*
  # Ett tillgängligt uppdrag väljs och en sökning görs visa gränssnittet [https://oppna-program-rp-pdl.googlecode.com/svn/wiki/images/search.png]
  # Användaren behöver intyga patientrelation om en sådan inte redan finns
  # Användaren får se information som tillhör vårdenheten för det valda medarbetaruppdraget
  # Användaren väljer att få se information från en annan vårdenhet (i de fall uppdraget tillåter det)
  # Då det finns spärrade vårdenheter kan användaren avgöra om dessa är relevant och välja att få se vart informationen finns
  # I det fall att användaren beslutar att den spärrade informationen är relevant så kan denne välja att passera spärren
  # Slutgiltligen väljer användaren att gå vidare och visa vårdsystem

*Sammanhållen Journalföring*
  # Ett tillgängligt uppdrag väljs och en sökning görs visa gränssnittet [https://oppna-program-rp-pdl.googlecode.com/svn/wiki/images/search.png]
  # Användaren behöver intyga patientrelation om en sådan inte redan finns
  # Användaren får se information som tillhör vårdenheten för det valda medarbetaruppdraget
  # Användaren väljer att få se information från en annan vårdgivare
  # Då det finns spärrade vårdenheter kan användaren avgöra om dessa är relevant och välja att få se vart informationen finns
  # Eftersom uppdraget är Sammanhållen Journalföring och informationen finns hos en annan vårgivare så kan inte användaren välja att passera spärren.
  # Slutgiltligen väljer användaren att gå vidare och visa vårdsystem

==Översiktlig systembeskrivning==
Systemet består av ett Portlet gränssnitt, samt ett antal interna tjänster som kommunicerar med tredjepartssystem. 

Systemet har även en PostgreSQL-databas i vilken logginformation sparas. Denna kan komma att ersättas med en loggtjänst i framtiden.

Information hämtas in från flera tjänster och ger i slutändan användaren möjlighet att se patientinformation.

[https://oppna-program-rp-pdl.googlecode.com/svn/wiki/pdf/PDL%20Informationso%CC%88versikt%20v01.pdf https://oppna-program-rp-pdl.googlecode.com/svn/wiki/images/PDL%20Informationso%CC%88versikt.png]
_[https://oppna-program-rp-pdl.googlecode.com/svn/wiki/pdf/PDL%20Informationso%CC%88versikt%20v01.pdf Diagram för informationsöversikt]_

==Informations- och verksamhetslogik==
Diagrammet beskriver standardflödet i verksamhetslogiken tillsammans med en beskrivning av hur information transformeras för varje steg.

[https://oppna-program-rp-pdl.googlecode.com/svn/wiki/pdf/PDL%20Verksamhetslogik%20v02.pdf https://oppna-program-rp-pdl.googlecode.com/svn/wiki/images/PDL%20Verksamhetslogik.png]
_[https://oppna-program-rp-pdl.googlecode.com/svn/wiki/pdf/PDL%20Verksamhetslogik%20v02.pdf Diagram för PDL Verksamhetslogik]_

==HSA Medarbetaruppdrag==
Diagrammet beskriver logiken för att hantera HSA medarbetaruppdrag.

[https://oppna-program-rp-pdl.googlecode.com/svn/wiki/pdf/HSA%20Medarbetaruppdrag%20v01.pdf https://oppna-program-rp-pdl.googlecode.com/svn/wiki/images/HSA%20Medarbetaruppdrag.png]
_[https://oppna-program-rp-pdl.googlecode.com/svn/wiki/pdf/HSA%20Medarbetaruppdrag%20v01.pdf Diagram för HSA medarbetaruppdrag]_

==Datalagring==
==Installation==
==Konfiguration==
==Felhantering==
==Loggning==

Loggning är en viktig komponent i PDL-tjänsten för att kunna i efterhand granska de val som en användare gjort i applikationen.

== Fält som ingår i loggtjänsten ==

Varje loggpost innehåller följande fält.

|| *Fältnamn* || *Beskrivning* || *Exempel* ||
|| id || Unikt id för raden || 021b9675-5b12-4f36-81e5-ead005adfd9d ||
|| employee_display_name || Visningsnamn för anställde || Karin Mattsson ||
|| employee_id || employee_id || SE2321000131-P000000000977 ||
|| patient_display_name || Visningsnamn för patient || Tian Testberg ||
|| patient_id || Patient ID (ex personnummer) || 201010101010 ||
|| assignment_display_name || Visningsnamn på medarbetaruppdrag || VoB SJF_NU Akutklinik ||
|| assignment_id || HSA-ID på medarbetaruppdrag || SE2321000131-S000000012310 ||
|| care_provider_display_name || Visningsnamn för vårdgivare || Västra Götalandsregionen ||
|| care_provider_id || HSA-ID på vårdgivare || SE2321000131-E000000000001 ||
|| care_unit_display_name || Visningsnamn för vårdenhet || Akutklinik ||
|| care_unit_id || HSA-ID på vårdenhet || SE2321000131-E000000006834 ||
|| creation_time || Tid när loggen skapades || 2014-03-03 15:11:11.133+01 ||
|| log_text || Text som beskriver vad användaren såg i gränssnittet || === UNDERSÖKNINGSRESULTAT === [ ] Västra Götalandsregionen - Verksamhet Medicin Geriatrik och Akutmottagning Östra ||
|| system_id || Identifiering på vilket system som loggat || Regionportalen - Sök Patient PDL ||
|| user_action || Vilket aktiva val som användaren utfört || ATTEST_RELATION ||
|| search_session || Unikt id för att knyta ihop de aktiva val som gjorts under en sökning || "bba806a0-d16c-4d59-9668-cec16f89f7e9" ||

Under en sökning skapas flera rader av logginformation i databasen. Det som är intressant är att se vilka aktiva val användaren gör. Detta skrivs in i fältet user_action ovan.

|| *Fältvärde* || *Loggningstillfälle* ||
|| SEARCH_PATIENT || När patienten trycker på sökknappen ||
|| ATTEST_RELATION || När en patientrelation behöver attesteras ||
|| ATTEST_CONSENT || När ett patientsamtycke till sammanhållen jounralföring attesteras ||
|| EMERGENCY_CONSENT || När en nödsituation råder och samtycke till sammanhållen journalföring behövs ||
|| REVEAL_BLOCKED || När användaren anser sig behöva få reda på vilken information som är skyddad ||
|| PASS_BLOCKED || Passera blockerad information med medgivande från patient ||
|| EMERGENCY_PASS_BLOCKED || Passera blockerad infomrmation vid nödsituation ||
|| REVEAL_OTHER_UNITS || Visar informationsresurstype från andra vårdgivare ||
|| REVEAL_OTHER_PROVIDER || Visar informationsresurstype från andra vårdenheter ||
|| SUMMARY_CARE_SYSTEMS || Visa summeringen för vårdapplikation ||
|| ENTER_CARE_SYSTEM || Vilken vårdapplikation som användaren öppnar ||

== Loggtjänsten i Säkerhetstjänsterna ==
Det finns en loggningstjänst i säkerhetstjänsterna, men den var ej klar vi byggandet av PDL-tjänsten. Därför togs beslutet att bygga en lokal loggtjänst i PDL-tjänsterna. Men utgå ifrån Säkerhetstjänsternas loggtjänst för att senare kunna byta över.

== Skillnad mellan Loggtjänst i Säkerhetstjänsten och i PDL-tjänstens logg ==

|| *Fältnamn PDL-logg* || *Fältnamn loggtjänst i Säkerhetstjänsterna*  || 
|| id || Log > LogId  ||  
|| employee_display_name || Log > User > Name  ||
|| employee_id || Log > User > UserId  || 
|| patient_display_name || Log > Resources > PatientName  ||
|| patient_id || Log > Resources > PatientId  ||
|| assignment_display_name ||  || 
|| assignment_id || Log > User > Assignment  || 
|| care_provider_display_name || Log > User > CareProvider > CareProviderName  ||
|| care_provider_id || Log > User > CareProvider > CareProviderId  || 
|| care_unit_display_name || Log > User > CareUnit > CareUnitName  ||
|| care_unit_id || Log > User > CareUnit > CareUnitId  || 
|| creation_time || Log > Activity > StartDate  || 
|| log_text || Log > Resources > Resource  || 
|| system_id || Log > System > SystemId  || 
|| user_action || ||
|| search_session || || 

==Lokala utvecklingsmiljö==
==Säkerhet==
==Kvarstående utvecklingspunkter==



----



Liferay projects for VGR to meet the legal requirements that Patientdatalagen requires of web applications

For more information please look at the page [Systemdokumentation] (in Swedish)

*Basic flow*

*1. A search for patient information is made by the user.*
https://oppna-program-rp-pdl.googlecode.com/svn/wiki/images/search.png

*2. Depending on the chosen assignment different information is visible*

*3. The user needs to decide what information is relevant for the particular case at hand*

*4. When the guide is through viewers are presented where the user will have access to specified information only*

The user's choices are logged and what is visible at any given moment is also logged.

===Dependencies===
The PDL portlet have several dependencies.

|| *Dependency* || *Role* ||
|| Siteminder || Provides strong authentication with SITHS Smart card ||
|| HSA WS || Directory service to preform lookups for Care Provider and Care Unit information ||
|| Patient Relation (SÄK) || An active patient relation between patient and user is mandatory to view patient information ||
|| Patient Consent (SÄK) || Consent determines if the patient allows for information to be shared with direct access between Care Providers ||
|| Blocks (SÄK) || Patients can prevent other Care Units or Care Providers from directly accessing their patient information ||
|| Authentication (SÄK) || SAML Federation to provide SSO, SLO and Centralized Assignment Choice ||
|| Source data || Different sources expose their information (see separate table) ||
|| Viewers || Information can have different viewers (see separate table) ||
|| Log repository || PostgreSQL database where log information is persisted, might change into a log service in the future ||

|| *Source* || *Type of information* || *Viewers* ||
|| Mawell Info Broker || Radiology requests and studies || GE Zero Footprint ||